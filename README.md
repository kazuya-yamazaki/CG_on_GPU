# OpenACC_CG_sample
GPU移植のための実装例（共役勾配法によるポアソン方程式求解）

## 概要
* 共役勾配法のC及びFORTRANのコードを、OpenACCでGPU対応する実例です
* OpenACCでは、元のCPU専用コードに指示文を挿入することでGPU対応するため、下記の場合に特に有用です
  * 大量の既存コードを最小限の手間でGPU化したい場合
  * 同一コードでCPU機・NVIDIA社製GPU搭載機の両方をサポートしたい場合
* 本レポジトリのプログラムのベースは、[東京大学情報基盤センターお試しアカウント付き並列プログラミング講習会「並列有限要素法で学ぶ並列プログラミング徹底入門」](http://nkl.cc.u-tokyo.ac.jp/FEMall/)で解説されている、CPU用のプログラムです。共役勾配法のアルゴリズムや、MPI・OpenMPによる並列化の方法に関しては、上記URLをご覧ください

## コンパイル方法

## C言語での指示文の挿入

## FORTRANでの指示文の挿入

## 性能向上のポイント
OpenACCでGPU化したプログラムの性能が不十分な場合、まずはプロファイラを使って遅い箇所を特定しましょう。

###何もない白い部分
CPU上の処理で時間がかかっていることが多いです。心当たりがあれば、そこもGPU対応してみましょう。

###水色やマゼンタの部分
CPUとGPUの間のデータ転送です。これが長い状況の原因は3つ考えられます：
  * CPUとGPUとでデータを交互に操作している場合：CPU部分のGPU化を進めることで、転送を削減しましょう。
  * CPUからはデータを触っておらず、転送が必要ない場合：`acc data`ディレクティブの指定をしましょう。
  * GPU上にあるデータをMPI通信に渡すためにCPUと転送している場合：上述のCUDA-aware MPIを使用しましょう。

###青色の部分
計算カーネルです。
#### FORTRANでの注意点
FORTRANではまれに、ループカウンタ変数を8バイト整数(`integer(8)`)にしないとカーネルの性能が低下することがあります。
