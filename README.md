# OpenACC_CG_sample
GPU移植のための実装例（共役勾配法によるポアソン方程式求解）

## 概要
* 共役勾配法のC及びFORTRANのコードを、OpenACCでGPU対応する実例です
* OpenACCでは、元のCPU専用コードに指示文を挿入することでGPU対応するため、下記の場合に特に有用です
  * 大量の既存コードを最小限の手間でGPU化したい場合
  * 同一コードでCPU機・NVIDIA社製GPU搭載機の両方をサポートしたい場合
* 本レポジトリのプログラムのベースは、[東京大学情報基盤センターお試しアカウント付き並列プログラミング講習会「並列有限要素法で学ぶ並列プログラミング徹底入門」](http://nkl.cc.u-tokyo.ac.jp/FEMall/)で解説されている、CPU用のプログラムです。共役勾配法のアルゴリズムや、MPI・OpenMPによる並列化の方法に関しては、上記URLをご覧ください

## 実行までの流れ

本サンプルコードは直方体格子上でポアソン方程式を解くプログラムです。実行の前に、格子サイズ・並列数を決めておき、直方体格子の定義ファイルを事前に生成しておく必要があります。
1. 主プログラムと格子生成プログラムをコンパイルする
1. 格子サイズ・並列数を決める
1. とを編集し、格子サイズ・並列数を反映させる
1. 格子生成プログラムを実行する
1. 主プログラムを実行し、ポアソン方程式を解く

### 主プログラムと格子生成プログラムのコンパイル
Wisteria Aqariusで実行する場合は、下記コマンドでNVIDIA HPC SDKを利用可能な状態にします。
```
module load nvidia nvmpi cuda
```
次に、ディレクトリ`pmesh/`に移動し、`mpif90 pmesh.f`を実行します。
さらに、ディレクトリ`../src/`に移動し、`make`を実行します。
ファイル`run/prog_gpu`が生成されていれば成功です。

### 格子サイズ・並列数を決める
### 設定ファイルを編集する
### 格子生成プログラムを実行する
```
cd pmesh/
nvfortran pmesh.f

# Wisteria Aquariusで実行する場合
pjsub pjsub_pmesh.sh
# ワークステーションなどで実行する場合
mpirun -n (並列数) ./a.out
```
### 主プログラムを実行する

## C言語での指示文の挿入

## FORTRANでの指示文の挿入
